{% extends "base.html" %}

{% block title %}Admin Dashboard - Inventory Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button type="button" class="btn btn-outline-success" onclick="exportData()">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Products</h6>
                        <h2 id="totalProducts">4</h2>
                        <small>Active inventory items</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Locations</h6>
                        <h2 id="totalLocations">4</h2>
                        <small>Warehouses & stores</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Movements</h6>
                        <h2 id="totalMovements">26</h2>
                        <small>This month</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Stock Value</h6>
                        <h2 id="totalValue">₹45,280</h2>
                        <small>Estimated value</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-indian-rupee-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Products</h5>
                        <p class="card-text">Manage your inventory items</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-box fa-2x"></i>
                    </div>
                </div>
                <a href="{{ url_for('products') }}" class="btn btn-light btn-sm">View All</a>
                <a href="{{ url_for('add_product') }}" class="btn btn-outline-light btn-sm">Add New</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Locations</h5>
                        <p class="card-text">Manage warehouse locations</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-warehouse fa-2x"></i>
                    </div>
                </div>
                <a href="{{ url_for('locations') }}" class="btn btn-light btn-sm">View All</a>
                <a href="{{ url_for('add_location') }}" class="btn btn-outline-light btn-sm">Add New</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Movements</h5>
                        <p class="card-text">Track product movements</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exchange-alt fa-2x"></i>
                    </div>
                </div>
                <a href="{{ url_for('movements') }}" class="btn btn-light btn-sm">View All</a>
                <a href="{{ url_for('add_movement') }}" class="btn btn-outline-light btn-sm">Add New</a>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Balance Report</h5>
                        <p class="card-text">View inventory balances</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-bar fa-2x"></i>
                    </div>
                </div>
                <a href="{{ url_for('balance_report') }}" class="btn btn-light btn-sm">View Report</a>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Section -->
<div class="row mt-4">
    <div class="col-lg-8 mb-4">
        <div class="card fade-in">
            <div class="card-header d-flex align-items-center justify-content-between">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Movements - Last 7 Days</h5>
            </div>
            <div class="card-body">
                <canvas id="movementsChart" height="120"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-4">
        <div class="card fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy"></i> Top Products</h5>
            </div>
            <div class="card-body">
                <canvas id="topProductsChart" height="220"></canvas>
            </div>
        </div>
        <div class="card mt-4 fade-in">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Recent Activity</h5>
            </div>
            <div class="card-body">
                <ul id="recentActivity" class="list-unstyled mb-0 small"></ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> Quick Start Guide
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-plus-circle text-primary"></i> Getting Started</h6>
                        <ol>
                            <li>Add your products</li>
                            <li>Create warehouse locations</li>
                            <li>Record product movements</li>
                            <li>View balance reports</li>
                        </ol>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-exchange-alt text-warning"></i> Movement Types</h6>
                        <ul>
                            <li><strong>Stock In:</strong> Leave "From Location" empty</li>
                            <li><strong>Stock Out:</strong> Leave "To Location" empty</li>
                            <li><strong>Transfer:</strong> Fill both locations</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fas fa-chart-line text-info"></i> Reports</h6>
                        <p>The Balance Report shows current stock levels for each product in each location, helping you track inventory across your warehouses.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Charts CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const el = document.getElementById('totalValue');
    if (!el) return;
    // Extract numeric value from the current text (e.g., "₹45,280" -> 45280)
    const numeric = parseFloat((el.textContent || '').replace(/[^0-9.]/g, ''));
    if (!isNaN(numeric)) {
      el.textContent = new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        maximumFractionDigits: 0
      }).format(numeric);
    }
  });
  
  // KPI counters from API
  document.addEventListener('DOMContentLoaded', async function () {
    try {
      const res = await fetch('/api/metrics');
      if (!res.ok) return;
      const data = await res.json();
      const setText = (id, v) => { const n = document.getElementById(id); if (n) n.textContent = v; };
      setText('totalProducts', data.products ?? '-');
      setText('totalLocations', data.locations ?? '-');
      setText('totalMovements', data.movements ?? '-');
    } catch (e) { /* ignore */ }
  });

  // Charts
  document.addEventListener('DOMContentLoaded', async function () {
    const ctx1 = document.getElementById('movementsChart');
    const ctx2 = document.getElementById('topProductsChart');
    if (ctx1) {
      try {
        const res = await fetch('/api/movements_trend');
        const payload = await res.json();
        new Chart(ctx1, {
          type: 'line',
          data: {
            labels: payload.labels,
            datasets: [{
              label: 'Movements',
              data: payload.data,
              tension: 0.35,
              borderColor: '#4f46e5',
              backgroundColor: 'rgba(79,70,229,0.25)',
              fill: true,
              pointRadius: 3
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--muted') } },
              y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--muted') } }
            }
          }
        });
      } catch (e) { /* ignore */ }
    }

    if (ctx2) {
      try {
        const res = await fetch('/api/top_products');
        const payload = await res.json();
        new Chart(ctx2, {
          type: 'bar',
          data: {
            labels: payload.labels,
            datasets: [{
              label: 'Qty moved',
              data: payload.data,
              backgroundColor: ['#4f46e5','#7c3aed','#16a34a','#f59e0b','#0891b2']
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--muted') } },
              y: { ticks: { color: getComputedStyle(document.body).getPropertyValue('--muted') } }
            }
          }
        });
      } catch (e) { /* ignore */ }
    }

    // Recent Activity
    try {
      const res = await fetch('/api/recent_movements');
      const { items } = await res.json();
      const list = document.getElementById('recentActivity');
      if (list && Array.isArray(items)) {
        list.innerHTML = items.map(i => {
          const dir = i.from_location && i.to_location ? 'Transfer' : (i.to_location ? 'Stock In' : 'Stock Out');
          return `<li class="mb-2">` +
                 `<span class="badge bg-secondary me-2">${dir}</span>` +
                 `<strong>${i.product_id}</strong> ` +
                 `<span class="text-muted">(${i.qty})</span> ` +
                 `<span class="text-muted">• ${new Date(i.timestamp).toLocaleString()}</span>` +
                 `</li>`;
        }).join('');
      }
    } catch (e) { /* ignore */ }
  });
  </script>
{% endblock %}
